{% extends 'base.html' %}

{% block content %}

{% load staticfiles %}
    <div class="right_col" role="main">
      <div class="">

        <!--<div class="page-title">
          <div class="title_left">
            <h3>BITACORA</h3>
          </div>
        </div>-->
        <div class="clearfix"></div>
        <div class="row">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                  <div class="x_title">
                    <h2>Datos nueva mantención</h2>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content">
                    <form id="form_mantencion" data-parsley-validate class="form-horizontal form-label-left" action="{% url 'mantencion_create_view' %}" method="post">{% csrf_token %}
                        {{ form.errors }}
                        {{ form.non_field_errors }}
                        <div class="form-group pull-in clearfix">
                            <div class="col-sm-2">
                                <label style="text-align:left;" class="control-label col-sm-12" for="{{ fecha.id_for_label }}">Fecha </label>
                                {{ form.fecha }}
                                {{ form.fecha.errors }}
                            </div>
                            <div class="col-sm-2">
                                <label style="text-align:left;" class="control-label col-sm-12" for="{{ compania.id_for_label }}">Compañía </label>
                                {{ form.compania }}
                                {{ form.compania.errors }}
                            </div>
                            <div class="col-sm-2">
                                <label style="text-align:left;" class="control-label col-sm-12" for="{{ maquina.id_for_label }}">Máquina </label>
                                {{ form.maquina }}
                                {{ form.maquina.errors }}
                            </div>
                            <div class="col-sm-2">
                                <label style="text-align:left;" class="control-label col-sm-12" for="{{ ki_salida.id_for_label }}">Kilometraje Salida </label>
                                {{ form.ki_salida }}
                                {{ form.ki_salida.errors }}
                            </div>
                            <div class="col-sm-2">
                                <label style="text-align:left;" class="control-label col-sm-12" for="{{ ki_regreso.id_for_label }}">Kilometraje Regreso </label>
                                {{ form.ki_regreso }}
                                {{ form.ki_regreso.errors }}
                            </div>
                        </div>
                        <div class="form-group pull-in clearfix">
                            <div class="col-sm-2">
                                <label style="text-align:left;" class="control-label col-sm-12" for="{{ ho_salida.id_for_label }}">Hodometro Salida </label>
                                {{ form.ho_salida }}
                                {{ form.ho_salida.errors }}
                            </div>
                            <div class="col-sm-2">
                                <label style="text-align:left;" class="control-label col-sm-12" for="{{ ho_regreso.id_for_label }}">Hodometro Regreso </label>
                                {{ form.ho_regreso }}
                                {{ form.ho_regreso.errors }}
                            </div>
                            <div class="col-sm-2">
                                <label style="text-align:left;" class="control-label col-sm-12" for="{{ cod_man.id_for_label }}">Orden de trabajo</label>
                                {{ form.cod_man }}
                                {{ form.cod_man.errors }}
                            </div>
                            {% if user.is_authenticated and user.usuariocomp.tipo == "3" %}
                                <div class="col-sm-2">
                                    <label style="text-align:left;" class="control-label col-sm-12" for="{{ num_factura.id_for_label }}">Nº factura </label>
                                    {{ form.num_factura }}
                                    {{ form.num_factura.errors }}
                                </div>
                                <div class="col-sm-2">
                                    <label style="text-align:left;" class="control-label col-sm-12" for="{{ valor.id_for_label }}">Costo Servicio</label>
                                    {{ form.valor }}
                                    {{ form.valor.errors }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="form-group pull-in clearfix">
                            <div class="col-sm-4">
                                <label style="text-align:left;" class="control-label col-md-12" for="{{ taller.id_for_label }}">Taller </label>
                                {{ form.taller }}
                                {{ form.taller.errors }}
                            </div>
                            <div class="col-sm-4">
                                <label style="text-align:left;" class="control-label col-sm-12" for="{{ responsable.id_for_label }}">Responsable </label>
                                {{ form.responsable }}
                                {{ form.responsable.errors }}
                            </div>
                            <div class="col-sm-4">
                                <label style="text-align:left;" class="control-label col-sm-12" for="{{ observacion.id_for_label }}">Observacion </label>
                                {{ form.observacion }}
                                {{ form.observacion.errors }}
                            </div>

                        </div>
                        <div class="ln_solid"></div>

                        <div class="form-group col-md-6 col-sm-6 col-xs-12 col-md-offset-3">
                            <button id="boton_form" type="submit" name="form" class="btn btn-success">Ingresar</button>
                        </div>
                    </form>
                  </div>
                  <div class="x_title" >
                    <h2>Ingreso detalle</h2>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content">
                    <!--<div class="col-xs-4 col-md-4">-->
                    <form id="form_mantencion_detalle" data-parsley-validate class="form-horizontal form-label-left" action="{% url 'mantencion_create_view' %}" method="post" >{% csrf_token %}
                        <div class="form-group pull-in clearfix">
                                {{ form2.mantencion }}
                            <!--<div class="col-sm-12">
                                <label style="text-align:left;" class="control-label col-sm-6" for="{{ componente.id_for_label }}">Componente</label>
                                {{ form2.componente }}
                                {{ form2.componente.errors }}
                            </div>-->
                            <div class="col-sm-4">
                                <label style="text-align:left;" class="control-label col-sm-6" for="{{ division.id_for_label }}">División</label>
                                {{ form2.division }}
                                {{ form2.division.errors }}
                            </div>
                            <div class="col-sm-3">
                                <label style="text-align:left;" class="control-label col-sm-6" for="{{ subdivision.id_for_label }}">Subdivisión</label>
                                {{ form2.subdivision }}
                                {{ form2.subdivision.errors }}
                            </div>
                            <div class="col-sm-3">
                                <label style="text-align:left;" class="control-label col-sm-6" for="{{ servicio.id_for_label }}">Servicio</label>
                                {{ form2.servicio }}
                                {{ form2.servicio.errors }}
                            </div>
                            <div class="col-sm-2">
                                <label style="text-align:left;" class="control-label col-sm-12" for="{{ tipo_mantencion.id_for_label }}">Tipo Mantención</label>
                                {{ form2.tipo_mantencion }}
                                {{ form2.tipo_mantencion.errors }}
                            </div>
                            
                        </div>
                        <div class="form-group pull-in clearfix">
                            <div class="col-sm-4">
                                <label style="text-align:left;" class="control-label col-md-6" for="{{ des_detalle.id_for_label }}">Observación </label>
                                {{ form2.des_detalle }}
                                {{ form2.des_detalle.errors }}
                            </div>
                            <div id="prox_man" class="col-sm-3">
                                <label style="text-align:left;" class="control-label col-sm-12" for="{{ hodometro_prox_man.id_for_label }}">Próxima Mantención</label>
                                {{ form2.hodometro_prox_man }}
                                {{ form2.hodometro_prox_man.errors }}
                            </div>
                        </div>
                        <div class="form-group pull-in clearfix">
                            <div class="col-sm-4">
                                <label style="text-align:left;" class="control-label col-sm-6" for="id_repuesto">Repuestos </label>
                                <input type="text" name="repuesto" class="form-control" maxlength="45" id="id_repuesto" />
                            </div>
                        </div>
                         <div id="before" class="form-group pull-in clearfix">
                            <div class="col-sm-12">
                                <button type="button" id="repuesto_add"><i class="fa fa-plus"></i></button>
                                <button type="button" id="repuesto_less"><i class="fa fa-minus"></i></button>
                            </div>
                        </div>
                        <div class="ln_solid"></div>
                        <div class="form-group col-md-6 col-sm-6 col-xs-12 col-md-offset-3">
                            <button id="boton_form_detalle_add" type="submit" name="form2" class="btn btn-success">Agregar detalle</button>
                        </div>
                    </form>
                    <!--</div>-->
                      <div class="col-xs-12 col-md-12">
                          <div class="table-responsive">
                            <table class="table" id="tabla_detalle">

    
                              <tbody>
                                <tr>
                                  <th>División</th>
                                  <th>Subdivisión</th>
                                  <th>Tipo Mantención</th>
                                  <th>Servicio</th>
                                  <th>Descripción</th>
                                  <th>Repuestos</th>
                                  <th>Prox. Mantencion</th>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        </div>
                  </div>
                  <div class="x_content">
                      <div class="ln_solid"></div>
                        <div class="form-group col-md-12 col-sm-6 col-xs-12">
                            <div align="right"><button id="finalizar" type="button" class="btn btn-success">Finalizar mantención</button></div>
                        </div>
                  </div>
                </div>
            </div>
        </div>
      </div>
    </div>
        <!-- /page content -->


    <!-- jQuery -->
    <script type="text/javascript" src="{% static 'admin/js/core.js' %}"></script>
    <script type="text/javascript" src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
    <script type="text/javascript" src="{% static 'admin/js/jquery.init.js' %}"></script>

    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <!--smart-selects-->
    <script type="text/javascript" src="{% static 'smart-selects/admin/js/chainedfk.js' %}"></script>
    <script type="text/javascript" src="{% static 'smart-selects/admin/js/chainedm2m.js' %}"></script>
    <script type="text/javascript" src="{% static 'smart-selects/admin/js/bindfields.js' %}"></script>

    <!-- Bootstrap -->
    <script type="text/javascript" src="{% static 'vendors/bootstrap/dist/js/bootstrap.min.js' %}"></script>

    <script type="text/javascript" src="{% static 'js/datepicker/bootstrap-datepicker.js' %}"></script>

    <script type="text/javascript" src="{% static 'vendors/datatables.net/js/jquery.dataTables.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendors/datatables.net-bs/js/dataTables.bootstrap.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendors/datatables.net-buttons/js/dataTables.buttons.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendors/datatables.net-buttons/js/buttons.flash.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendors/datatables.net-buttons/js/buttons.html5.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendors/datatables.net-buttons/js/buttons.print.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendors/datatables.net-keytable/js/dataTables.keyTable.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendors/datatables.net-responsive/js/dataTables.responsive.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendors/datatables.net-scroller/js/dataTables.scroller.min.js' %}"></script>

    <!-- Custom Theme Scripts -->
    <script type="text/javascript" src="{% static 'js/custom.js' %}"></script>

    <!-- bootstrap-daterangepicker -->
    <script>
      $(document).ready(function() {
        $('#id_maquina').addClass('form-control');
        $('#id_servicio').addClass('form-control');
        $('#id_subdivision').addClass('form-control');

        $('#fecha').datepicker({format: "yyyy-mm-dd",weekStart: 1});

        $("#form_mantencion_detalle").find('input, textarea, button, select').attr('disabled',true);
        $("#prox_man").hide();
      });
    </script>

    <script>
    
    	$("#id_tipo_mantencion").change(function(){
    		var id_tipo = this.value;
    		
    		if(id_tipo === "1" ){
    			$("#prox_man").hide();
    		}
    		else{
    			$("#prox_man").show();
    		}
    		
    	});

        $("#id_maquina").change(function(){
            var maquina = this.value;
            if(maquina !== ""){
                var datos_form = $("#form_mantencion :hidden").serialize();
                var datos = datos_form+"&maquina="+maquina;
                console.log(datos);
                $.ajax({
                    url: "{% url 'get_parametros_maquina' %}",
                    type: "POST",
                    data: datos,
                    success: function (data) {
                        $("#id_ki_salida").empty();
                        $("#id_ho_salida").empty();
                        $("#id_ho_bomba_salida").empty();
                        $("#id_ho_bomba_regreso").empty();
                        for(var i in data.parametros) {
                            if(data.parametros[i].kilometraje !== null && data.parametros[i].kilometraje !== null){
                                $("#id_ki_salida").val(data.parametros[i].kilometraje);
                                $("#id_ho_salida").val(data.parametros[i].hodometro);
                            }
                            else{
                                $("#id_ki_salida").val("");
                                $("#id_ho_salida").val("");
                            }
                            
                            console.log(data.parametros[i].kilometraje);  // (o el campo que necesites)
                        }
                    }
                });
            }
        });


        $("#form_mantencion").on( "submit", function( event ) {
          event.preventDefault();
          var datos =  $( this ).serialize();
          console.log(datos);
          $.ajax({
            //url: "http://localhost:8000/mantencion/add/",
            url: "{% url 'mantencion_form_view' %}",
            type: "POST",
            data: datos,
            success:function(data){
                console.log(data);
                $("#id_mantencion").val(data['pk']);
                //-->NECESARIO $("#id_mantencion_detalle").val(data['pk']);
                $("#form_mantencion").find('input, textarea, button, select').attr('disabled',true);
                $("#form_mantencion_detalle").find('input, textarea, button, select').attr('disabled',false);
                //$("#boton_form").attr('disabled',true);
            }
          });
        });

        $("#repuesto_add").on('click',function () {
            var rep = $("#id_repuesto")[0].outerHTML;
            console.log(rep);
            var n = $('input[name="repuesto"]').length;
            var repuesto_nuevo = $("#id_repuesto").parent().parent().html();
            $("#before").before("<div id=rep_"+n+" class='form-group pull-in clearfix'><div class='col-sm-4'>"+rep+"</div></div>");
        });

        $("#repuesto_less").on('click',function () {
            var n = $('input[name="repuesto"]').length;
            if (n > 1){
                n = n - 1;
                $("#rep_"+n).remove();
            }

            /*$('input[name="repuesto"]').each(function () {
                var value = $( this ).val();
                console.log(value);
            });*/
        });



        $("#form_mantencion_detalle").on('submit',function (event) {
            event.preventDefault();
            //var componente = $("#id_componente").val();
            var division = $("#id_division").val();
            var subdivision = $("#id_subdivision").val();
            var servicio = $("#id_servicio").val();
            var tipo_mantencion = $("#id_tipo_mantencion").val();
            var des_detalle = $("#id_des_detalle").val();
            var prox_man = $("#id_hodometro_prox_man").val();
            var bandera = true;

            var datos_detalle = $("#form_mantencion_detalle :hidden").serialize();
            var datos = datos_detalle+"&division="+division+"&subdivision="+subdivision+"&servicio="+servicio+"&tipo_mantencion="+tipo_mantencion+"&hodometro_prox_man="+prox_man+"&des_detalle="+des_detalle;
            console.log(datos);
            $.ajax({
                url: "{% url 'detalle_mantencion_form_view' %}",
                type: "POST",
                data: datos,
                success:function(data){
                    console.log(data);
                    //-->NECESARIO $("#id_detalle_mantencion").val(data['pk']);
                    $('#id_repuesto').each(function () {
                        var valuerep = $(this).html();
                        console.log(valuerep);
                        var datos_repuesto = datos_detalle+"&detalle_mantencion="+data['pk']+"&repuesto="+valuerep;
                        console.log(datos_repuesto);
                        /*$.ajax({
                            url: "{% url 'repuesto_detalle_mantencion_form_view' %}",
                            type: "POST",
                            data: datos_repuesto,
                            success: function (data) {
                                if (data['status'] !== 'ok'){
                                    bandera = false;
                                }
                                else{
                                    bandera = true;
                                }
                            }
                        });*/
                    });
                }
            });

            if (bandera){
                var repuestos = "";
                var cont = 0;
                $('input[name="repuesto"]').each(function () {
                    var value_rep = $( this ).val();
                    if (cont === 0){
                        repuestos = value_rep;
                    }
                    else{
                        repuestos = repuestos+", "+value_rep;
                    }
                    cont++;

                });
                if (prox_man === ""){
                    $("#tabla_detalle").append("<tr><td>"+division+"</td><td>"+subdivision+"</td><td>"+servicio+"</td><td>"+tipo_mantencion+"</td><td>"+des_detalle+"</td><td>"+repuestos+"</td><td></td></tr>");
                }
                else{
                    $("#tabla_detalle").append("<tr><td>"+division+"</td><td>"+subdivision+"</td><td>"+servicio+"</td><td>"+tipo_mantencion+"</td><td>"+des_detalle+"</td><td>"+repuestos+"</td><td>"+prox_man+" km</td></tr>");
                }
                $("#id_division").val("");
                $("#id_subdivision").val("");
                $("#id_servicio").val("");
                $("#id_tipo_mantencion").val("");
                $("#id_des_detalle").val("");
                $("#id_hodometro_prox_man").val("");
                $('input[name="repuesto"]').each(function () {
                    $( this ).val("");
                });
                var n = $('input[name="repuesto"]').length;
                while (n > 1){
                    n = n - 1;
                    $("#rep_"+n).remove();
                }
            }


        });

        $("#finalizar").on('click',function () {
           window.location.replace("{% url 'mantencion_list' %}");
        });

    function commaSeparateNumber(valor){
        while (/(\d+)(\d{3})/.test(valor.toString())){
          valor = valor.toString().replace(/(\d+)(\d{3})/, '$1'+'.'+'$2');
        }
        return valor;
    }

    </script>

{% endblock %}